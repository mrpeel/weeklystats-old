<!DOCTYPE html>
<html>
<head>
  <title>LASSI2 Weekly Status</title>
   <link rel="stylesheet" href="simple_demo.css">
</head>
<body>


<header class="Header" id="header">
	<div class="Header-block">
		<span class="Header-menu" id="header-menu">
		</span>

		<div class="Header-user" id="header-user">

		</div>
		<div class="u-hidden u-lg-block">

      <div class="Titles Titles--hero">
      <h1 class="Titles-main">LASSI2</h1>

      <div class="Titles-sub">Weekly Stats</div>
      </div>
    </div>
	</div>
	<aside class="Header-auth" id="header-auth">
		<div class="Header-embedApi" id="embed-api-auth-container"/>
		<a class="Header-logout" href="https://accounts.google.com/logout">Logout</a>
	</aside>
</header>



<div class="Dashboard Dashboard--full">


  <div class="Screenshot" id="auth-button"></div>

  <div class="Titles">
  	<h1 class="Titles-main" id="view-name">Select a View</h1>
  </div>


  <div id="view-selector-container"></div>
  <div class="Screenshot"></div>




  <ul class="FlexGrid FlexGrid--halves">
  		<li class="FlexGrid-item">
  		  <div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Week Session Usage Comparison</h1>
  					<div class="Titles-sub">By sessions</div>
  				</header>
          <figure class="Chartjs-figure" id="weekly-session-chart-container"/>
        </div>
        <div class="Chartjs-legend" id="weekly-session-legend-container"/>
      </li>

  		<li class="FlexGrid-item">
  			<div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Month Session Usage Comparison</h1>
  					<div class="Titles-sub">By sessions</div>
  				</header>
  				<figure class="Chartjs-figure" id="monthly-session-chart-container"/>
  			</div>
  		<div class="Chartjs-legend" id="monthly-session-legend-container"/>
  		</li>

  		<li class="FlexGrid-item">
  		  <div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Week Session Duration Comparison</h1>
  					<div class="Titles-sub">By average session length (seconds)</div>
  				</header>
          <figure class="Chartjs-figure" id="weekly-session-duration-chart-container"/>
        </div>
        <div class="Chartjs-legend" id="weekly-session-duration-legend-container"/>
      </li>
  		<li class="FlexGrid-item">
  			<div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Month Session Duration Comparison</h1>
  					<div class="Titles-sub">By average session length (seconds)</div>
  				</header>
  				<figure class="Chartjs-figure" id="monthly-session-duration-chart-container"/>
  			</div>
  		<div class="Chartjs-legend" id="monthly-session-duration-legend-container"/>
  		</li>

  		<li class="FlexGrid-item">
    		  <div class="Chartjs">
    				<header class="Titles">
    					<h1 class="Titles-main">Week Content Usage Comparison</h1>
    					<div class="Titles-sub">By page views</div>
    				</header>
            <figure class="Chartjs-figure" id="weekly-content-chart-container"/>
          </div>
        <div class="Chartjs-legend" id="weekly-content-legend-container"/>
      </li>

  		<li class="FlexGrid-item">
  			<div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Month Content Usage Comparison</h1>
  					<div class="Titles-sub">By page views</div>
  				</header>
  				<figure class="Chartjs-figure" id="monthly-content-chart-container"/>
  			</div>
  		<div class="Chartjs-legend" id="monthly-content-legend-container"/>
  		</li>

  		<li class="FlexGrid-item">
  		  <div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Week Browser Comparison</h1>
  					<div class="Titles-sub">By page views</div>
  				</header>
          <figure class="Chartjs-figure" id="weekly-browser-chart-container"/>
        </div>
        <div class="Chartjs-legend" id="weekly-browser-legend-container"/>
      </li>

  		<li class="FlexGrid-item">
  			<div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Past Year Browser Comparison</h1>
  					<div class="Titles-sub">By page views</div>
  				</header>
  				<figure class="Chartjs-figure" id="yearly-browser-chart-container"/>
  			</div>
  		<div class="Chartjs-legend" id="yearly-browser-legend-container"/>
  		</li>

  		<li class="FlexGrid-item">
  		  <div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Week Internet Explorer Comparison</h1>
  					<div class="Titles-sub">By page views</div>
  				</header>
          <figure class="Chartjs-figure" id="weekly-ieversionr-chart-container"/>
        </div>
        <div class="Chartjs-legend" id="weekly-ieversionr-legend-container"/>
      </li>

  		<li class="FlexGrid-item">
  			<div class="Chartjs">
  				<header class="Titles">
  					<h1 class="Titles-main">Quarterly Internet Explorer Comparison</h1>
  					<div class="Titles-sub">By page views</div>
  				</header>
  				<figure class="Chartjs-figure" id="chart-6-container"/>
  			</div>
  		<div class="Chartjs-legend" id="legend-6-container"/>
  		</li>

  </ul>

</div>



<!-- Step 2: Load the library. -->
<script>
(function(w,d,s,g,js,fjs){
  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(cb){this.q.push(cb)}};
  js=d.createElement(s);fjs=d.getElementsByTagName(s)[0];
  js.src='https://apis.google.com/js/platform.js';
  fjs.parentNode.insertBefore(js,fjs);js.onload=function(){g.load('analytics')};
}(window,document,'script'));
</script>


<script src="javascript/Chart.min.js"></script>

<script src="javascript/moment.min.js"></script>

<!-- Include the ViewSelector2 component script. -->
<script src="javascript/view-selector2.js"></script>

<!-- Include the DateRangeSelector component script. -->
<script src="javascript/date-range-selector.js"></script>

<!-- Include the ActiveUsers component script. -->
<script src="javascript/active-users.js"></script>

<script>
gapi.analytics.ready(function() {

  // Step 3: Authorize the user.

  var CLIENT_ID = '940998236407-ll26vtigl8bs52nt0ld3cumii6kmesmg.apps.googleusercontent.com';

  gapi.analytics.auth.authorize({
    container: 'auth-button',
    clientid: CLIENT_ID,
  });



  gapi.analytics.auth.on('success', function(response) {
    viewSelector.execute();
  });

   /**
   * Create a new ViewSelector2 instance to be rendered inside of an
   * element with the id "view-selector-container".
   */
  var viewSelector = new gapi.analytics.ext.ViewSelector2({
    container: 'view-selector-container',
  })
  .execute();

  viewSelector.on('viewChange', function(data) {

    var title = document.getElementById('view-name');
    title.innerHTML = data.property.name + ' (' + data.view.name + ')';

    var startDateCurrentWeek = '2014-12-01';
    var endDateCurrentWeek = '2014-12-07';
    var startDatePreviousWeek = '2014-11-24';
    var endDatePreviousWeek = '2014-11-30';


    renderWeekOverWeekChart(data.ids, startDateCurrentWeek, endDateCurrentWeek,
                            startDatePreviousWeek, endDatePreviousWeek);

    renderYearOverYearChart(data.ids, endDateCurrentWeek);



    renderWeekOverWeekSessionDurationChart(data.ids, startDateCurrentWeek, endDateCurrentWeek,
                            startDatePreviousWeek, endDatePreviousWeek);

    renderYearOverYearSessionDurationChart(data.ids, endDateCurrentWeek);



    renderWeekContentUsageChart(data.ids, startDateCurrentWeek, endDateCurrentWeek);



    renderTopBrowsersPeriod(data.ids, startDateCurrentWeek, endDateCurrentWeek);

    renderTopBrowsersYear(data.ids, endDateCurrentWeek);

  });


  function renderWeekOverWeekChart(ids, startDateCurrentWeek, endDateCurrentWeek,
                            startDatePreviousWeek, endDatePreviousWeek) {


    var currentWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:sessions',
      'start-date': startDateCurrentWeek,
      'end-date': endDateCurrentWeek
    });

    var previousWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:sessions',
      'start-date': startDatePreviousWeek,
      'end-date':  endDatePreviousWeek
    });

    Promise.all([currentWeek, previousWeek]).then(function(results) {

      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      var labels = results[1].rows.map(function(row) { return +row[0]; });

      labels = labels.map(function(label) {
        return moment(label, 'YYYYMMDD').format('ddd');
      });

      var data = {
        labels : labels,
        datasets : [
          {
            //Set week ending date
            //label: 'Last Week',
            label: 'Week Starting ' + moment(startDatePreviousWeek, 'YYYYMMDD').format('DD/MM/YYYY'),
            fillColor : "rgba(220,220,220,0.5)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            data : data2
          },
          {
            label: 'Week Starting ' + moment(startDateCurrentWeek, 'YYYYMMDD').format('DD/MM/YYYY'),
            fillColor : "rgba(151,187,205,0.5)",
            strokeColor : "rgba(151,187,205,1)",
            pointColor : "rgba(151,187,205,1)",
            pointStrokeColor : "#fff",
            data : data1
          }
        ]
      };

      new Chart(makeCanvas('weekly-session-chart-container')).Line(data);
      generateLegend('weekly-session-legend-container', data.datasets);
    });
  }


  /**
     * Draw the a chart.js bar chart with data from the specified view that
     * overlays session data for the current year over session data for the
     * previous year, grouped by month.
     */
    function renderYearOverYearChart(ids, endDate) {

      var thisYear = query({
        'ids': ids,
        'dimensions': 'ga:month,ga:nthMonth',
        'metrics': 'ga:sessions',
        'start-date': moment(endDate).date(1).month(0).format('YYYY-MM-DD'),
        'end-date': moment(endDate).format('YYYY-MM-DD')
      });

      var lastYear = query({
        'ids': ids,
        'dimensions': 'ga:month,ga:nthMonth',
        'metrics': 'ga:sessions',
        'start-date': moment(endDate).subtract(1, 'year').date(1).month(0)
            .format('YYYY-MM-DD'),
        'end-date': moment(endDate).date(1).month(0).subtract(1, 'day')
            .format('YYYY-MM-DD')
      });

      Promise.all([thisYear, lastYear]).then(function(results) {
        var data1 = results[0].rows.map(function(row) { return +row[2]; });
        var data2 = results[1].rows.map(function(row) { return +row[2]; });
        var labels = ['Jan','Feb','Mar','Apr','May','Jun',
                      'Jul','Aug','Sep','Oct','Nov','Dec'];

        // Ensure the data arrays are at least as long as the labels array.
        // Chart.js bar charts don't (yet) accept sparse datasets.
        for (var i = 0, len = labels.length; i < len; i++) {
          if (data1[i] === undefined) data1[i] = null;
          if (data2[i] === undefined) data2[i] = null;
        }

        var data = {
          labels : labels,
          datasets : [
            {
              label: 'Last Year',
              fillColor : "rgba(220,220,220,0.5)",
              strokeColor : "rgba(220,220,220,1)",
              data : data2
            },
            {
              label: 'This Year',
              fillColor : "rgba(151,187,205,0.5)",
              strokeColor : "rgba(151,187,205,1)",
              data : data1
            }
          ]
        };

        new Chart(makeCanvas('monthly-session-chart-container')).Bar(data);
        generateLegend('monthly-session-legend-container', data.datasets);
      })
      .catch(function(err) {
        console.error(err.stack);
      })
    }

  /* Calculates the number of seconds avergae dution for a session for the current and previous week */

  function renderWeekOverWeekSessionDurationChart(ids, startDateCurrentWeek, endDateCurrentWeek,
                            startDatePreviousWeek, endDatePreviousWeek) {


    var currentWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:avgSessionDuration',
      'start-date': startDateCurrentWeek,
      'end-date': endDateCurrentWeek
    });

    var previousWeek = query({
      'ids': ids,
      'dimensions': 'ga:date,ga:nthDay',
      'metrics': 'ga:avgSessionDuration',
      'start-date': startDatePreviousWeek,
      'end-date':  endDatePreviousWeek
    });

    Promise.all([currentWeek, previousWeek]).then(function(results) {

      var data1 = results[0].rows.map(function(row) { return +row[2]; });
      var data2 = results[1].rows.map(function(row) { return +row[2]; });
      var labels = results[1].rows.map(function(row) { return +row[0]; });

      labels = labels.map(function(label) {
        return moment(label, 'YYYYMMDD').format('ddd');
      });

      var data = {
        labels : labels,
        datasets : [
          {
            //Set week ending date
            //label: 'Last Week',
            label: 'Week Starting ' + moment(startDatePreviousWeek, 'YYYYMMDD').format('DD/MM/YYYY'),
            fillColor : "rgba(220,220,220,0.5)",
            strokeColor : "rgba(220,220,220,1)",
            pointColor : "rgba(220,220,220,1)",
            pointStrokeColor : "#fff",
            data : data2
          },
          {
            label: 'Week Starting ' + moment(startDateCurrentWeek, 'YYYYMMDD').format('DD/MM/YYYY'),
            fillColor : "rgba(151,187,205,0.5)",
            strokeColor : "rgba(151,187,205,1)",
            pointColor : "rgba(151,187,205,1)",
            pointStrokeColor : "#fff",
            data : data1
          }
        ]
      };

      new Chart(makeCanvas('weekly-session-duration-chart-container')).Line(data);
      generateLegend('weekly-session-duration-legend-container', data.datasets);
    });
  }

  /*Calculates the average number of seconds duration of a session for this year to the previous
    year*/

  function renderYearOverYearSessionDurationChart(ids, endDate) {

      var thisYear = query({
        'ids': ids,
        'dimensions': 'ga:month,ga:nthMonth',
        'metrics': 'ga:avgSessionDuration',
        'start-date': moment(endDate).date(1).month(0).format('YYYY-MM-DD'),
        'end-date': moment(endDate).format('YYYY-MM-DD')
      });

      var lastYear = query({
        'ids': ids,
        'dimensions': 'ga:month,ga:nthMonth',
        'metrics': 'ga:avgSessionDuration',
        'start-date': moment(endDate).subtract(1, 'year').date(1).month(0)
            .format('YYYY-MM-DD'),
        'end-date': moment(endDate).date(1).month(0).subtract(1, 'day')
            .format('YYYY-MM-DD')
      });

      Promise.all([thisYear, lastYear]).then(function(results) {
        var data1 = results[0].rows.map(function(row) { return +row[2]; });
        var data2 = results[1].rows.map(function(row) { return +row[2]; });
        var labels = ['Jan','Feb','Mar','Apr','May','Jun',
                      'Jul','Aug','Sep','Oct','Nov','Dec'];

        // Ensure the data arrays are at least as long as the labels array.
        // Chart.js bar charts don't (yet) accept sparse datasets.
        for (var i = 0, len = labels.length; i < len; i++) {
          if (data1[i] === undefined) data1[i] = null;
          if (data2[i] === undefined) data2[i] = null;
        }

        var data = {
          labels : labels,
          datasets : [
            {
              label: 'Last Year',
              fillColor : "rgba(220,220,220,0.5)",
              strokeColor : "rgba(220,220,220,1)",
              data : data2
            },
            {
              label: 'This Year',
              fillColor : "rgba(151,187,205,0.5)",
              strokeColor : "rgba(151,187,205,1)",
              data : data1
            }
          ]
        };

        new Chart(makeCanvas('monthly-session-duration-chart-container')).Bar(data);
        generateLegend('monthly-session-duration-legend-container', data.datasets);
      })
      .catch(function(err) {
        console.error(err.stack);
      })
    }


/**
   * Draw the a chart.js doughnut chart with data from the specified view that
   * shows the content for the week.
   */
  function renderWeekContentUsageChart(ids, startDate, endDate) {

    query({
      'ids': ids,
      'dimensions': 'ga:pageTitle',
      'metrics': 'ga:pageviews',
      'filters': 'ga:pageTitle!=Redirect;ga:pageviews>10',
      'start-date': startDate,
      'end-date':  endDate,
      'sort': '-ga:pageviews',
      'max-results': 10

    })
    .then(function(response) {

      var data = [];
      var labels = [];
      var datasets = [];
      var colors = ['#4D5360','#949FB1','#D4CCC5','#ADD7FE','#FEADAD','#C1FEC2', '#C1FEE3', '#FFF9D1', '#F1FFD1', '#D1FFD1', '#D1FFEA'];

      response.rows.forEach(function(row, i) {
        //labels.push(row[0]);
        labels.push('');
        datasets.push(  {
                        label: row[0],
                        fillColor: colors[i],
                        strokeColor: colors[i],
                        data: [+row[1]]
                      }  );
      });

      data = {labels: labels, datasets: datasets};

      new Chart(makeCanvas('weekly-content-chart-container')).Bar(data, {barDatasetSpacing : 10});
      generateLegend('weekly-content-legend-container', data.datasets);
    })
    .catch(function(err) {
      console.error(err.stack);
    })

  }


 /**
   * Draw the a chart.js doughnut chart with data from the specified view that
   * show the top 5 browsers over the past 30 days.
   */
  function renderTopBrowsersPeriod(ids, startDate, endDate) {

    query({
      'ids': ids,
      'dimensions': 'ga:browser',
      'metrics': 'ga:pageviews',
      'start-date': startDate,
      'end-date':  endDate,
      'sort': '-ga:pageviews',
      'max-results': 5
    })
    .then(function(response) {

      var data = [];
      var colors = ['#FEADAD','#ADD7FE','#BBFEAD','#ADFEEB','#FEFCAD'];

      response.rows.forEach(function(row, i) {
        data.push({ value: +row[1], color: colors[i], label: row[0] });
      });

      new Chart(makeCanvas('weekly-browser-chart-container')).Doughnut(data);
      generateLegend('weekly-browser-legend-container', data);
    });
  }


 /**
   * Draw the a chart.js doughnut chart with data from the specified view that
   * show the top 5 browsers.
   */
  function renderTopBrowsersYear(ids, endDate) {

    query({
      'ids': ids,
      'dimensions': 'ga:browser',
      'metrics': 'ga:pageviews',
      'start-date': moment(endDate).subtract(1, 'year').format('YYYY-MM-DD'),
      'end-date': endDate,
      'sort': '-ga:pageviews',
      'max-results': 5
    })
    .then(function(response) {

      var data = [];
      var colors = ['#FFC399','#A3FF99','#99FFD9','#99C8FF','#B199FF'];

      response.rows.forEach(function(row, i) {
        data.push({ value: +row[1], color: colors[i], label: row[0] });
      });

      new Chart(makeCanvas('yearly-browser-chart-container')).Doughnut(data);
      generateLegend('yearly-browser-legend-container', data);
    });
  }

  /**
     * Extend the Embed APIs `gapi.analytics.report.Data` component to
     * return a promise the is fulfilled with the value returned by the API.
     * @param {Object} params The request parameters.
     * @return {Promise} A promise.
     */
    function query(params) {
      return new Promise(function(resolve, reject) {
        var data = new gapi.analytics.report.Data({query: params});
        data.once('success', function(response) { resolve(response); })
            .once('error', function(response) { reject(response); })
            .execute();
      });
    }


    /**
     * Create a new canvas inside the specified element. Set it to be the width
     * and height of its container.
     * @param {string} id The id attribute of the element to host the canvas.
     * @return {RenderingContext} The 2D canvas context.
     */
    function makeCanvas(id) {
      var container = document.getElementById(id);
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');

      container.innerHTML = '';
      canvas.width = container.offsetWidth;
      canvas.height = container.offsetHeight;
      container.appendChild(canvas);

      return ctx;
    }


    /**
     * Create a visual legend inside the specified element based off of a
     * Chart.js dataset.
     * @param {string} id The id attribute of the element to host the legend.
     * @param {Array.<Object>} items A list of labels and colors for the legend.
     */
    function generateLegend(id, items) {
      var legend = document.getElementById(id);
      legend.innerHTML = items.map(function(item) {
        var color = item.color || item.fillColor;
        var label = item.label;
        return '<li><i style="background:' + color + '"></i>' + label + '</li>';
      }).join('');
    }


    // Set some global Chart.js defaults.
    Chart.defaults.global.animationSteps = 60;
    Chart.defaults.global.animationEasing = 'easeInOutQuart';
    Chart.defaults.global.responsive = true;
    Chart.defaults.global.maintainAspectRatio                                           